/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { HttpResponse } from '@angular/common/http';
import { of } from 'rxjs';
import { startWith, tap } from 'rxjs/operators';
import { RequestCache } from './cache.service';
/**
 * If request is cachable (e.g., package search) and
 * response is in cache return the cached response as observable.
 *
 * If not in cache or not cachable,
 * pass request through to next()
 */
var CachingInterceptor = /** @class */ (function () {
    function CachingInterceptor(cache) {
        this.cache = cache;
    }
    /**
     * @param {?} req
     * @param {?} next
     * @return {?}
     */
    CachingInterceptor.prototype.intercept = /**
     * @param {?} req
     * @param {?} next
     * @return {?}
     */
    function (req, next) {
        if (req.headers.has('CACHE_GALLERY_IMAGE') && isCachable(req)) {
            /** @type {?} */
            var cachedResponse = this.cache.get(req);
            // cache-then-refresh
            if (req.headers.get('x-refresh')) {
                /** @type {?} */
                var results$ = sendRequest(req, next, this.cache);
                return cachedResponse
                    ? results$.pipe(startWith(cachedResponse))
                    : results$;
            }
            // cache-or-fetch
            return cachedResponse
                ? of(cachedResponse)
                : sendRequest(req, next, this.cache);
        }
        return next.handle(req);
    };
    CachingInterceptor.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    CachingInterceptor.ctorParameters = function () { return [
        { type: RequestCache }
    ]; };
    return CachingInterceptor;
}());
export { CachingInterceptor };
if (false) {
    /**
     * @type {?}
     * @private
     */
    CachingInterceptor.prototype.cache;
}
/**
 * Is this request cachable?
 * @param {?} req
 * @return {?}
 */
function isCachable(req) {
    // Only GET requests are cachable
    return req.method === 'GET';
}
/**
 * Get server response observable by sending request to `next()`.
 * Will add the response to the cache on the way out.
 * @param {?} req
 * @param {?} next
 * @param {?} cache
 * @return {?}
 */
function sendRequest(req, next, cache) {
    /** @type {?} */
    var request = req.clone({ headers: req.headers.delete('CACHE_GALLERY_IMAGE') });
    return next.handle(request).pipe(tap(function (event) {
        // There may be other events besides the response.
        if (event instanceof HttpResponse) {
            cache.put(req, event); // Update the cache.
        }
    }));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUuaW50ZXJjZXB0b3IuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Abmd4LWdhbGxlcnkvY29yZS8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9jYWNoZS5pbnRlcmNlcHRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQXVDLFlBQVksRUFBbUIsTUFBTSxzQkFBc0IsQ0FBQztBQUUxRyxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFaEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlCQUFpQixDQUFDOzs7Ozs7OztBQVUvQztJQUVFLDRCQUFvQixLQUFtQjtRQUFuQixVQUFLLEdBQUwsS0FBSyxDQUFjO0lBQ3ZDLENBQUM7Ozs7OztJQUVELHNDQUFTOzs7OztJQUFULFVBQVUsR0FBcUIsRUFBRSxJQUFpQjtRQUNoRCxJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLElBQUksVUFBVSxDQUFDLEdBQUcsQ0FBQyxFQUFFOztnQkFFdkQsY0FBYyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztZQUUxQyxxQkFBcUI7WUFDckIsSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsRUFBRTs7b0JBQzFCLFFBQVEsR0FBRyxXQUFXLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDO2dCQUNuRCxPQUFPLGNBQWM7b0JBQ25CLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQztvQkFDMUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQzthQUNkO1lBQ0QsaUJBQWlCO1lBQ2pCLE9BQU8sY0FBYztnQkFDbkIsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxjQUFjLENBQUM7Z0JBQ3BCLENBQUMsQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDeEM7UUFDRCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDMUIsQ0FBQzs7Z0JBdkJGLFVBQVU7Ozs7Z0JBVkYsWUFBWTs7SUFrQ3JCLHlCQUFDO0NBQUEsQUF4QkQsSUF3QkM7U0F2Qlksa0JBQWtCOzs7Ozs7SUFDakIsbUNBQTJCOzs7Ozs7O0FBeUJ6QyxTQUFTLFVBQVUsQ0FBQyxHQUFxQjtJQUN2QyxpQ0FBaUM7SUFDakMsT0FBTyxHQUFHLENBQUMsTUFBTSxLQUFLLEtBQUssQ0FBQztBQUM5QixDQUFDOzs7Ozs7Ozs7QUFNRCxTQUFTLFdBQVcsQ0FBQyxHQUFxQixFQUFFLElBQWlCLEVBQUUsS0FBbUI7O1FBQzFFLE9BQU8sR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLHFCQUFxQixDQUFDLEVBQUMsQ0FBQztJQUMvRSxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUM5QixHQUFHLENBQUMsVUFBQSxLQUFLO1FBQ1Asa0RBQWtEO1FBQ2xELElBQUksS0FBSyxZQUFZLFlBQVksRUFBRTtZQUNqQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLG9CQUFvQjtTQUM1QztJQUNILENBQUMsQ0FBQyxDQUNILENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBIdHRwRXZlbnQsIEh0dHBIYW5kbGVyLCBIdHRwUmVxdWVzdCwgSHR0cFJlc3BvbnNlLCBIdHRwSW50ZXJjZXB0b3IgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcblxyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBzdGFydFdpdGgsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbmltcG9ydCB7IFJlcXVlc3RDYWNoZSB9IGZyb20gJy4vY2FjaGUuc2VydmljZSc7XHJcblxyXG4vKipcclxuICogSWYgcmVxdWVzdCBpcyBjYWNoYWJsZSAoZS5nLiwgcGFja2FnZSBzZWFyY2gpIGFuZFxyXG4gKiByZXNwb25zZSBpcyBpbiBjYWNoZSByZXR1cm4gdGhlIGNhY2hlZCByZXNwb25zZSBhcyBvYnNlcnZhYmxlLlxyXG4gKlxyXG4gKiBJZiBub3QgaW4gY2FjaGUgb3Igbm90IGNhY2hhYmxlLFxyXG4gKiBwYXNzIHJlcXVlc3QgdGhyb3VnaCB0byBuZXh0KClcclxuICovXHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBDYWNoaW5nSW50ZXJjZXB0b3IgaW1wbGVtZW50cyBIdHRwSW50ZXJjZXB0b3Ige1xyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgY2FjaGU6IFJlcXVlc3RDYWNoZSkge1xyXG4gIH1cclxuXHJcbiAgaW50ZXJjZXB0KHJlcTogSHR0cFJlcXVlc3Q8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpIHtcclxuICAgIGlmIChyZXEuaGVhZGVycy5oYXMoJ0NBQ0hFX0dBTExFUllfSU1BR0UnKSAmJiBpc0NhY2hhYmxlKHJlcSkpIHtcclxuXHJcbiAgICAgIGNvbnN0IGNhY2hlZFJlc3BvbnNlID0gdGhpcy5jYWNoZS5nZXQocmVxKTtcclxuXHJcbiAgICAgIC8vIGNhY2hlLXRoZW4tcmVmcmVzaFxyXG4gICAgICBpZiAocmVxLmhlYWRlcnMuZ2V0KCd4LXJlZnJlc2gnKSkge1xyXG4gICAgICAgIGNvbnN0IHJlc3VsdHMkID0gc2VuZFJlcXVlc3QocmVxLCBuZXh0LCB0aGlzLmNhY2hlKTtcclxuICAgICAgICByZXR1cm4gY2FjaGVkUmVzcG9uc2VcclxuICAgICAgICAgID8gcmVzdWx0cyQucGlwZShzdGFydFdpdGgoY2FjaGVkUmVzcG9uc2UpKVxyXG4gICAgICAgICAgOiByZXN1bHRzJDtcclxuICAgICAgfVxyXG4gICAgICAvLyBjYWNoZS1vci1mZXRjaFxyXG4gICAgICByZXR1cm4gY2FjaGVkUmVzcG9uc2VcclxuICAgICAgICA/IG9mKGNhY2hlZFJlc3BvbnNlKVxyXG4gICAgICAgIDogc2VuZFJlcXVlc3QocmVxLCBuZXh0LCB0aGlzLmNhY2hlKTtcclxuICAgIH1cclxuICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXEpO1xyXG4gIH1cclxufVxyXG5cclxuLyoqIElzIHRoaXMgcmVxdWVzdCBjYWNoYWJsZT8gKi9cclxuZnVuY3Rpb24gaXNDYWNoYWJsZShyZXE6IEh0dHBSZXF1ZXN0PGFueT4pIHtcclxuICAvLyBPbmx5IEdFVCByZXF1ZXN0cyBhcmUgY2FjaGFibGVcclxuICByZXR1cm4gcmVxLm1ldGhvZCA9PT0gJ0dFVCc7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBHZXQgc2VydmVyIHJlc3BvbnNlIG9ic2VydmFibGUgYnkgc2VuZGluZyByZXF1ZXN0IHRvIGBuZXh0KClgLlxyXG4gKiBXaWxsIGFkZCB0aGUgcmVzcG9uc2UgdG8gdGhlIGNhY2hlIG9uIHRoZSB3YXkgb3V0LlxyXG4gKi9cclxuZnVuY3Rpb24gc2VuZFJlcXVlc3QocmVxOiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlciwgY2FjaGU6IFJlcXVlc3RDYWNoZSk6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcclxuICBjb25zdCByZXF1ZXN0ID0gcmVxLmNsb25lKHtoZWFkZXJzOiByZXEuaGVhZGVycy5kZWxldGUoJ0NBQ0hFX0dBTExFUllfSU1BR0UnKX0pO1xyXG4gIHJldHVybiBuZXh0LmhhbmRsZShyZXF1ZXN0KS5waXBlKFxyXG4gICAgdGFwKGV2ZW50ID0+IHtcclxuICAgICAgLy8gVGhlcmUgbWF5IGJlIG90aGVyIGV2ZW50cyBiZXNpZGVzIHRoZSByZXNwb25zZS5cclxuICAgICAgaWYgKGV2ZW50IGluc3RhbmNlb2YgSHR0cFJlc3BvbnNlKSB7XHJcbiAgICAgICAgY2FjaGUucHV0KHJlcSwgZXZlbnQpOyAvLyBVcGRhdGUgdGhlIGNhY2hlLlxyXG4gICAgICB9XHJcbiAgICB9KVxyXG4gICk7XHJcbn1cclxuIl19