/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { HttpResponse } from '@angular/common/http';
import { of } from 'rxjs';
import { startWith, tap } from 'rxjs/operators';
import { RequestCache } from './cache.service';
/**
 * If request is cachable (e.g., package search) and
 * response is in cache return the cached response as observable.
 *
 * If not in cache or not cachable,
 * pass request through to next()
 */
export class CachingInterceptor {
    /**
     * @param {?} cache
     */
    constructor(cache) {
        this.cache = cache;
    }
    /**
     * @param {?} req
     * @param {?} next
     * @return {?}
     */
    intercept(req, next) {
        if (req.headers.has('CACHE_GALLERY_IMAGE') && isCachable(req)) {
            /** @type {?} */
            const cachedResponse = this.cache.get(req);
            // cache-then-refresh
            if (req.headers.get('x-refresh')) {
                /** @type {?} */
                const results$ = sendRequest(req, next, this.cache);
                return cachedResponse
                    ? results$.pipe(startWith(cachedResponse))
                    : results$;
            }
            // cache-or-fetch
            return cachedResponse
                ? of(cachedResponse)
                : sendRequest(req, next, this.cache);
        }
        return next.handle(req);
    }
}
CachingInterceptor.decorators = [
    { type: Injectable }
];
/** @nocollapse */
CachingInterceptor.ctorParameters = () => [
    { type: RequestCache }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    CachingInterceptor.prototype.cache;
}
/**
 * Is this request cachable?
 * @param {?} req
 * @return {?}
 */
function isCachable(req) {
    // Only GET requests are cachable
    return req.method === 'GET';
}
/**
 * Get server response observable by sending request to `next()`.
 * Will add the response to the cache on the way out.
 * @param {?} req
 * @param {?} next
 * @param {?} cache
 * @return {?}
 */
function sendRequest(req, next, cache) {
    /** @type {?} */
    const request = req.clone({ headers: req.headers.delete('CACHE_GALLERY_IMAGE') });
    return next.handle(request).pipe(tap(event => {
        // There may be other events besides the response.
        if (event instanceof HttpResponse) {
            cache.put(req, event); // Update the cache.
        }
    }));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUuaW50ZXJjZXB0b3IuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Abmd4LWdhbGxlcnkvY29yZS8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9jYWNoZS5pbnRlcmNlcHRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQXVDLFlBQVksRUFBbUIsTUFBTSxzQkFBc0IsQ0FBQztBQUUxRyxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFaEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlCQUFpQixDQUFDOzs7Ozs7OztBQVcvQyxNQUFNLE9BQU8sa0JBQWtCOzs7O0lBQzdCLFlBQW9CLEtBQW1CO1FBQW5CLFVBQUssR0FBTCxLQUFLLENBQWM7SUFDdkMsQ0FBQzs7Ozs7O0lBRUQsU0FBUyxDQUFDLEdBQXFCLEVBQUUsSUFBaUI7UUFDaEQsSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLFVBQVUsQ0FBQyxHQUFHLENBQUMsRUFBRTs7a0JBRXZELGNBQWMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUM7WUFFMUMscUJBQXFCO1lBQ3JCLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLEVBQUU7O3NCQUMxQixRQUFRLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQztnQkFDbkQsT0FBTyxjQUFjO29CQUNuQixDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLENBQUM7b0JBQzFDLENBQUMsQ0FBQyxRQUFRLENBQUM7YUFDZDtZQUNELGlCQUFpQjtZQUNqQixPQUFPLGNBQWM7Z0JBQ25CLENBQUMsQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDO2dCQUNwQixDQUFDLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3hDO1FBQ0QsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzFCLENBQUM7OztZQXZCRixVQUFVOzs7O1lBVkYsWUFBWTs7Ozs7OztJQVlQLG1DQUEyQjs7Ozs7OztBQXlCekMsU0FBUyxVQUFVLENBQUMsR0FBcUI7SUFDdkMsaUNBQWlDO0lBQ2pDLE9BQU8sR0FBRyxDQUFDLE1BQU0sS0FBSyxLQUFLLENBQUM7QUFDOUIsQ0FBQzs7Ozs7Ozs7O0FBTUQsU0FBUyxXQUFXLENBQUMsR0FBcUIsRUFBRSxJQUFpQixFQUFFLEtBQW1COztVQUMxRSxPQUFPLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxFQUFDLENBQUM7SUFDL0UsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FDOUIsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFO1FBQ1Ysa0RBQWtEO1FBQ2xELElBQUksS0FBSyxZQUFZLFlBQVksRUFBRTtZQUNqQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLG9CQUFvQjtTQUM1QztJQUNILENBQUMsQ0FBQyxDQUNILENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBIdHRwRXZlbnQsIEh0dHBIYW5kbGVyLCBIdHRwUmVxdWVzdCwgSHR0cFJlc3BvbnNlLCBIdHRwSW50ZXJjZXB0b3IgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcblxyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBzdGFydFdpdGgsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbmltcG9ydCB7IFJlcXVlc3RDYWNoZSB9IGZyb20gJy4vY2FjaGUuc2VydmljZSc7XHJcblxyXG4vKipcclxuICogSWYgcmVxdWVzdCBpcyBjYWNoYWJsZSAoZS5nLiwgcGFja2FnZSBzZWFyY2gpIGFuZFxyXG4gKiByZXNwb25zZSBpcyBpbiBjYWNoZSByZXR1cm4gdGhlIGNhY2hlZCByZXNwb25zZSBhcyBvYnNlcnZhYmxlLlxyXG4gKlxyXG4gKiBJZiBub3QgaW4gY2FjaGUgb3Igbm90IGNhY2hhYmxlLFxyXG4gKiBwYXNzIHJlcXVlc3QgdGhyb3VnaCB0byBuZXh0KClcclxuICovXHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBDYWNoaW5nSW50ZXJjZXB0b3IgaW1wbGVtZW50cyBIdHRwSW50ZXJjZXB0b3Ige1xyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgY2FjaGU6IFJlcXVlc3RDYWNoZSkge1xyXG4gIH1cclxuXHJcbiAgaW50ZXJjZXB0KHJlcTogSHR0cFJlcXVlc3Q8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpIHtcclxuICAgIGlmIChyZXEuaGVhZGVycy5oYXMoJ0NBQ0hFX0dBTExFUllfSU1BR0UnKSAmJiBpc0NhY2hhYmxlKHJlcSkpIHtcclxuXHJcbiAgICAgIGNvbnN0IGNhY2hlZFJlc3BvbnNlID0gdGhpcy5jYWNoZS5nZXQocmVxKTtcclxuXHJcbiAgICAgIC8vIGNhY2hlLXRoZW4tcmVmcmVzaFxyXG4gICAgICBpZiAocmVxLmhlYWRlcnMuZ2V0KCd4LXJlZnJlc2gnKSkge1xyXG4gICAgICAgIGNvbnN0IHJlc3VsdHMkID0gc2VuZFJlcXVlc3QocmVxLCBuZXh0LCB0aGlzLmNhY2hlKTtcclxuICAgICAgICByZXR1cm4gY2FjaGVkUmVzcG9uc2VcclxuICAgICAgICAgID8gcmVzdWx0cyQucGlwZShzdGFydFdpdGgoY2FjaGVkUmVzcG9uc2UpKVxyXG4gICAgICAgICAgOiByZXN1bHRzJDtcclxuICAgICAgfVxyXG4gICAgICAvLyBjYWNoZS1vci1mZXRjaFxyXG4gICAgICByZXR1cm4gY2FjaGVkUmVzcG9uc2VcclxuICAgICAgICA/IG9mKGNhY2hlZFJlc3BvbnNlKVxyXG4gICAgICAgIDogc2VuZFJlcXVlc3QocmVxLCBuZXh0LCB0aGlzLmNhY2hlKTtcclxuICAgIH1cclxuICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXEpO1xyXG4gIH1cclxufVxyXG5cclxuLyoqIElzIHRoaXMgcmVxdWVzdCBjYWNoYWJsZT8gKi9cclxuZnVuY3Rpb24gaXNDYWNoYWJsZShyZXE6IEh0dHBSZXF1ZXN0PGFueT4pIHtcclxuICAvLyBPbmx5IEdFVCByZXF1ZXN0cyBhcmUgY2FjaGFibGVcclxuICByZXR1cm4gcmVxLm1ldGhvZCA9PT0gJ0dFVCc7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBHZXQgc2VydmVyIHJlc3BvbnNlIG9ic2VydmFibGUgYnkgc2VuZGluZyByZXF1ZXN0IHRvIGBuZXh0KClgLlxyXG4gKiBXaWxsIGFkZCB0aGUgcmVzcG9uc2UgdG8gdGhlIGNhY2hlIG9uIHRoZSB3YXkgb3V0LlxyXG4gKi9cclxuZnVuY3Rpb24gc2VuZFJlcXVlc3QocmVxOiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlciwgY2FjaGU6IFJlcXVlc3RDYWNoZSk6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcclxuICBjb25zdCByZXF1ZXN0ID0gcmVxLmNsb25lKHtoZWFkZXJzOiByZXEuaGVhZGVycy5kZWxldGUoJ0NBQ0hFX0dBTExFUllfSU1BR0UnKX0pO1xyXG4gIHJldHVybiBuZXh0LmhhbmRsZShyZXF1ZXN0KS5waXBlKFxyXG4gICAgdGFwKGV2ZW50ID0+IHtcclxuICAgICAgLy8gVGhlcmUgbWF5IGJlIG90aGVyIGV2ZW50cyBiZXNpZGVzIHRoZSByZXNwb25zZS5cclxuICAgICAgaWYgKGV2ZW50IGluc3RhbmNlb2YgSHR0cFJlc3BvbnNlKSB7XHJcbiAgICAgICAgY2FjaGUucHV0KHJlcSwgZXZlbnQpOyAvLyBVcGRhdGUgdGhlIGNhY2hlLlxyXG4gICAgICB9XHJcbiAgICB9KVxyXG4gICk7XHJcbn1cclxuIl19